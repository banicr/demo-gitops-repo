name: GitOps - Deploy to Kind Cluster

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Specific image tag to deploy (leave empty for latest)'
        required: false
        type: string
  repository_dispatch:
    types: [deploy-from-app-repo]

env:
  DOCKER_IMAGE: ghcr.io/banicr/demo-flask-app
  CLUSTER_NAME: gitops-test-cluster

permissions:
  contents: read

jobs:
  deploy-with-argocd:
    name: Deploy with ArgoCD on Kind
    runs-on: ubuntu-latest
    steps:
      - name: Checkout GitOps repository
        uses: actions/checkout@v4

      - name: Install kind
        run: |
          echo "ðŸ“¦ Installing kind..."
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind version

      - name: Install kubectl
        run: |
          echo "ðŸ“¦ Installing kubectl..."
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          kubectl version --client

      - name: Create kind cluster
        run: |
          echo "ðŸš€ Creating kind cluster..."
          kind create cluster --name ${{ env.CLUSTER_NAME }} --wait 5m
          kubectl cluster-info --context kind-${{ env.CLUSTER_NAME }}
          kubectl get nodes

      - name: Determine image tag
        id: image_tag
        run: |
          if [ -n "${{ github.event.inputs.image_tag }}" ]; then
            # Use manually specified tag
            IMAGE_TAG="${{ github.event.inputs.image_tag }}"
            echo "Using manually specified tag: $IMAGE_TAG"
          elif [ "${{ github.event.action }}" == "deploy-from-app-repo" ]; then
            # Use tag from repository_dispatch event
            IMAGE_TAG="${{ github.event.client_payload.image_tag }}"
            echo "Using tag from app-repo: $IMAGE_TAG"
          else
            # Use latest tag
            IMAGE_TAG="latest"
            echo "Using latest tag"
          fi
          
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

      - name: Pull image from GHCR
        env:
          # Use PAT if available, otherwise try public pull
          GHCR_TOKEN: ${{ secrets.GHCR_PAT || secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“¥ Pulling image: ${{ env.DOCKER_IMAGE }}:${{ steps.image_tag.outputs.image_tag }}"
          
          # Try without authentication first (for public images)
          if docker pull ${{ env.DOCKER_IMAGE }}:${{ steps.image_tag.outputs.image_tag }} 2>/dev/null; then
            echo "âœ… Image pulled successfully (public image)"
          else
            echo "âš ï¸ Public pull failed, attempting authenticated pull..."
            
            # Check if we have GHCR_PAT secret
            if [ -n "${{ secrets.GHCR_PAT }}" ]; then
              echo "ðŸ” Using GHCR_PAT for authentication"
              echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            else
              echo "âš ï¸ No GHCR_PAT found. Please either:"
              echo "  1. Make the image public at: https://github.com/banicr?tab=packages"
              echo "  2. Create a PAT with 'read:packages' scope and add as GHCR_PAT secret"
              echo ""
              echo "Trying with GITHUB_TOKEN (may fail for cross-repo access)..."
              echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            fi
            
            docker pull ${{ env.DOCKER_IMAGE }}:${{ steps.image_tag.outputs.image_tag }}
            echo "âœ… Image pulled successfully"
          fi
          
          echo ""
          echo "ðŸ“¦ Pulled images:"
          docker images | grep demo-flask-app
      - name: Load image into kind cluster
        run: |
          echo "ðŸ“¦ Loading image into kind cluster..."
          kind load docker-image \
            ${{ env.DOCKER_IMAGE }}:${{ steps.image_tag.outputs.image_tag }} \
            --name ${{ env.CLUSTER_NAME }}
          
          echo "âœ… Image loaded into kind"

      - name: Install ArgoCD
        run: |
          echo "ðŸŽ¯ Installing ArgoCD..."
          kubectl create namespace argocd
          kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
          
          echo "â³ Waiting for ArgoCD to be ready..."
          kubectl wait --for=condition=available --timeout=300s \
            deployment/argocd-server -n argocd
          
          kubectl wait --for=condition=available --timeout=300s \
            deployment/argocd-repo-server -n argocd
          
          kubectl wait --for=condition=available --timeout=300s \
            deployment/argocd-applicationset-controller -n argocd
          
          echo "âœ… ArgoCD installed successfully"

      - name: Configure ArgoCD
        run: |
          echo "âš™ï¸ Configuring ArgoCD..."
          
      - name: Update manifests with image tag
        if: steps.image_tag.outputs.image_tag != 'latest'
        run: |
          echo "ðŸ”§ Updating manifests with image tag: ${{ steps.image_tag.outputs.image_tag }}"
          
          cd k8s/base
          
          # Update kustomization.yaml
          sed -i "s|newTag:.*|newTag: ${{ steps.image_tag.outputs.image_tag }}|g" kustomization.yaml
          
          # Update deployment.yaml APP_VERSION
          sed -i "s|value:.*# APP_VERSION|value: \"${{ steps.image_tag.outputs.image_tag }}\" # APP_VERSION|g" deployment.yaml
          
          echo "âœ… Manifests updated"
          cat kustomization.yaml

      - name: Deploy ArgoCD Application
        run: |
          echo "ðŸš€ Deploying ArgoCD Application..."
          
          # Create demo-app namespace
          kubectl create namespace demo-app || true
          
          # Apply ArgoCD Application manifest
          kubectl apply -f argocd-application.yaml
          
          echo "â³ Waiting for ArgoCD to sync application..."
          sleep 30
          
          # Check application status
          kubectl get applications -n argocd
          
          echo "âœ… ArgoCD Application deployed"

      - name: Wait for application deployment
        run: |
          echo "â³ Waiting for demo-flask-app deployment..."
          
          # Wait for deployment to be available
          kubectl wait --for=condition=available --timeout=300s \
            deployment/demo-flask-app -n demo-app || true
          
          # Show deployment status
          echo "ðŸ“Š Deployment status:"
          kubectl get all -n demo-app
          
          echo "ðŸ“‹ Pod details:"
          kubectl describe pods -n demo-app -l app=demo-flask-app || true

      - name: Test deployed application
        run: |
          echo "ðŸ§ª Testing deployed application..."
          
          # Port forward application service
          kubectl port-forward -n demo-app service/demo-flask-app 8081:80 > /dev/null 2>&1 &
          APP_PF_PID=$!
          sleep 5
          
          # Test health endpoint
          echo "Testing /healthz endpoint..."
          HEALTH_RESPONSE=$(curl -s http://localhost:8081/healthz || echo "failed")
          echo "Response: $HEALTH_RESPONSE"
          
          if echo "$HEALTH_RESPONSE" | grep -q '"status":"ok"'; then
            echo "âœ… Health check passed"
          else
            echo "âŒ Health check failed"
            kill $APP_PF_PID || true
            exit 1
          fi
          
          # Test root endpoint
          echo "Testing / endpoint..."
          ROOT_RESPONSE=$(curl -s http://localhost:8081/ || echo "failed")
          
          if echo "$ROOT_RESPONSE" | grep -q "Demo Flask App"; then
            echo "âœ… Root endpoint passed"
          else
            echo "âŒ Root endpoint failed"
            kill $APP_PF_PID || true
            exit 1
          fi
          
          # Cleanup
          kill $APP_PF_PID || true
          
          echo "ðŸŽ‰ All tests passed!"

      - name: Get ArgoCD application details
        if: always()
        run: |
          echo "ðŸ“Š ArgoCD Application Status:"
          kubectl get applications -n argocd -o wide || true
          
          echo ""
          echo "ðŸ“Š ArgoCD Application Details:"
          kubectl describe application demo-flask-app -n argocd || true

      - name: Deployment summary
        if: always()
        run: |
          echo "### ðŸŽ¯ GitOps Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster:** \`kind-${{ env.CLUSTER_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**GitOps Operator:** ArgoCD" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.DOCKER_IMAGE }}:${{ steps.image_tag.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace:** \`demo-app\`" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** Fetched from GHCR (app-repo published)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **Status:** Deployment successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Deployment failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Cleanup kind cluster
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up kind cluster..."
          kind delete cluster --name ${{ env.CLUSTER_NAME }} || true

      - name: Deployment summary
        if: always()
        run: |
          echo "### ðŸŽ¯ GitOps Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster:** \`kind-${{ env.CLUSTER_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**GitOps Operator:** ArgoCD" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.DOCKER_IMAGE }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace:** \`demo-app\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **Status:** Deployment successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Deployment failed" >> $GITHUB_STEP_SUMMARY
          fi
