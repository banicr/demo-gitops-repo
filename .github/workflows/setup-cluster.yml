name: Setup Kind Cluster with ArgoCD

on:
  workflow_dispatch:
    inputs:
      cluster_name:
        description: 'Cluster name'
        required: false
        default: 'gitops-demo'
        type: string

env:
  CLUSTER_NAME: ${{ github.event.inputs.cluster_name || 'gitops-demo' }}

permissions:
  contents: read

jobs:
  setup-cluster:
    name: Setup Persistent Kind Cluster
    runs-on: ubuntu-latest
    steps:
      - name: Checkout GitOps repository
        uses: actions/checkout@v4

      - name: Install kind
        run: |
          echo "ðŸ“¦ Installing kind..."
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind version

      - name: Install kubectl
        run: |
          echo "ðŸ“¦ Installing kubectl..."
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          kubectl version --client

      - name: Create kind cluster
        run: |
          echo "ðŸš€ Creating kind cluster: ${{ env.CLUSTER_NAME }}"
          
          # Create cluster with ingress-ready config
          cat <<EOF | kind create cluster --name ${{ env.CLUSTER_NAME }} --config=-
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
          - role: control-plane
            kubeadmConfigPatches:
            - |
              kind: InitConfiguration
              nodeRegistration:
                kubeletExtraArgs:
                  node-labels: "ingress-ready=true"
            extraPortMappings:
            - containerPort: 80
              hostPort: 8080
              protocol: TCP
            - containerPort: 443
              hostPort: 8443
              protocol: TCP
          EOF
          
          kubectl cluster-info --context kind-${{ env.CLUSTER_NAME }}
          kubectl get nodes
          echo "âœ… Cluster created successfully"

      - name: Install ArgoCD
        run: |
          echo "ðŸ“¦ Installing ArgoCD..."
          
          # Create argocd namespace
          kubectl create namespace argocd
          
          # Install ArgoCD
          kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
          
          echo "â³ Waiting for ArgoCD to be ready..."
          kubectl wait --for=condition=available --timeout=300s \
            deployment/argocd-server -n argocd
          
          echo "âœ… ArgoCD installed successfully"

      - name: Get ArgoCD initial password
        run: |
          echo "ðŸ”‘ Getting ArgoCD admin password..."
          
          # Wait a bit for secret to be created
          sleep 10
          
          ARGOCD_PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret \
            -o jsonpath="{.data.password}" | base64 -d)
          
          echo "### ðŸŽ‰ Cluster Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster Name:** \`${{ env.CLUSTER_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ArgoCD Access:**" >> $GITHUB_STEP_SUMMARY
          echo "- Username: \`admin\`" >> $GITHUB_STEP_SUMMARY
          echo "- Password: \`${ARGOCD_PASSWORD}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Port-forward ArgoCD UI: \`kubectl port-forward svc/argocd-server -n argocd 8080:443\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Access at: https://localhost:8080" >> $GITHUB_STEP_SUMMARY
          echo "3. Deploy the application: \`kubectl apply -f argocd-application.yaml\`" >> $GITHUB_STEP_SUMMARY
          echo "4. ArgoCD will automatically sync from this repo" >> $GITHUB_STEP_SUMMARY

      - name: Deploy ArgoCD Application
        run: |
          echo "ðŸš€ Deploying ArgoCD Application..."
          
          # Create demo-app namespace
          kubectl create namespace demo-app || true
          
          # Apply ArgoCD Application manifest
          kubectl apply -f argocd-application.yaml
          
          echo "â³ Waiting for initial sync..."
          sleep 30
          
          # Check application status
          kubectl get applications -n argocd
          
          echo "âœ… ArgoCD Application deployed and will auto-sync on changes"

      - name: Verify deployment
        run: |
          echo "ðŸ” Verifying deployment..."
          
          # Wait for deployment
          kubectl wait --for=condition=available --timeout=300s \
            deployment/demo-flask-app -n demo-app || true
          
          # Show status
          echo "ðŸ“Š Deployment status:"
          kubectl get all -n demo-app
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Status:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get all -n demo-app >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Instructions
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Usage Instructions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**This cluster is now running and ready for GitOps!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "When you push code to \`app-repo\`:" >> $GITHUB_STEP_SUMMARY
          echo "1. CI builds and pushes new image" >> $GITHUB_STEP_SUMMARY
          echo "2. CI updates manifests in this repo" >> $GITHUB_STEP_SUMMARY
          echo "3. ArgoCD detects the change automatically" >> $GITHUB_STEP_SUMMARY
          echo "4. ArgoCD syncs the new version to the cluster" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To access the application:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "kubectl port-forward -n demo-app service/demo-flask-app 8081:80" >> $GITHUB_STEP_SUMMARY
          echo "curl http://localhost:8081/healthz" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
