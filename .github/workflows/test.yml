name: Test - Validate Manifests

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  lint-yaml:
    name: Lint YAML Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yamllint
        run: |
          pip install yamllint

      - name: Run yamllint
        run: |
          echo "ðŸ” Linting YAML files..."
          yamllint -c .yamllint.yml . || yamllint .
        continue-on-error: true

  validate-manifests:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Install kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Validate Kubernetes manifests
        run: |
          echo "âœ… Validating Kubernetes manifests..."
          
          # Validate individual manifests
          for file in k8s/base/*.yaml; do
            echo "Validating $file..."
            kubectl apply --dry-run=client -f "$file" || echo "âš ï¸  Warning: $file validation failed"
          done

      - name: Validate Kustomize build
        run: |
          echo "ðŸ”§ Building with Kustomize..."
          kustomize build k8s/base > /tmp/rendered-manifests.yaml
          
          echo "ðŸ“‹ Rendered manifests:"
          cat /tmp/rendered-manifests.yaml
          
          echo ""
          echo "âœ… Validating rendered manifests..."
          kubectl apply --dry-run=client -f /tmp/rendered-manifests.yaml

      - name: Validate ArgoCD Application manifest
        run: |
          echo "ðŸŽ¯ Validating ArgoCD Application manifest..."
          kubectl apply --dry-run=client -f argocd-application.yaml

  security-scan:
    name: Security Scan Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy security scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Run kubesec security scanner
        run: |
          echo "ðŸ”’ Running kubesec security scan..."
          
          # Install kubesec
          wget https://github.com/controlplaneio/kubesec/releases/download/v2.13.0/kubesec_linux_amd64.tar.gz
          tar -xzf kubesec_linux_amd64.tar.gz
          sudo mv kubesec /usr/local/bin/
          
          # Scan deployment manifest
          echo "Scanning deployment.yaml..."
          kubesec scan k8s/base/deployment.yaml || true
        continue-on-error: true

  test-kustomize-overlays:
    name: Test Kustomize Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Test kustomize base
        run: |
          echo "ðŸ”§ Testing kustomize base configuration..."
          kustomize build k8s/base
          
          echo ""
          echo "âœ… Kustomize base build successful"

      - name: Verify image references
        run: |
          echo "ðŸ” Verifying image references..."
          
          # Check if kustomization.yaml has correct image reference
          if grep -q "ghcr.io/banicr/demo-flask-app" k8s/base/kustomization.yaml; then
            echo "âœ… Image reference found in kustomization.yaml"
          else
            echo "âŒ Image reference not found in kustomization.yaml"
            exit 1
          fi

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint-yaml, validate-manifests, security-scan, test-kustomize-overlays]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "### ðŸ§ª GitOps Repository Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| YAML Lint | ${{ needs.lint-yaml.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Manifest Validation | ${{ needs.validate-manifests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Kustomize Tests | ${{ needs.test-kustomize-overlays.result }} |" >> $GITHUB_STEP_SUMMARY
